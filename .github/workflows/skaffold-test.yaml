name: Skaffold Test Workflow

on:
    pull_request:
      types: [opened,reopened,synchronize,closed]

permissions:
    contents: read
    pull-requests: write
    id-token: write

jobs:
    # Try
    try:
        name: Skaffold Docker build
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v3

            # Create/Connect to Uffizzi Virtual Cluster
            - name: Connect to Virtual Cluster
              uses: UffizziCloud/cluster-action@main
              with:
                cluster-name: pr-${{ github.event.pull_request.number }}

            - shell: bash
              run: |
                #Install Skaffold
                curl -Lo skaffold https://storage.googleapis.com/skaffold/releases/latest/skaffold-linux-amd64 && \
                sudo install skaffold /usr/local/bin/

                cat kubeconfig

                kubectl config set-context --kubeconfig=kubeconfig uc-pr-${{ github.event.pull_request.number }}

                skaffold dev --default-repo registry.uffizzi.com -f skaffold.yaml

            # - name: Build Docker images
            #   uses: hiberbee/github-action-skaffold@1.20.0
            #   with:
            #     command: dev
            #     repository: registry.uffizzi.com